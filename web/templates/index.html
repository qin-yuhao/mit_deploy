<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êú∫Âô®ÁãóÊéßÂà∂Âô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .status-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .status-item {
            display: inline-block;
            margin: 10px 20px;
            font-size: 1.1em;
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-transform: uppercase;
        }

        .mode-btn.passive { background: #6c757d; }
        .mode-btn.lie-down { background: #dc3545; }
        .mode-btn.stand-up { background: #28a745; }
        .mode-btn.rl-model { background: #007bff; }
        .mode-btn.soft-stop { background: #fd7e14; }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .mode-btn.active {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .control-section {
            margin-bottom: 30px;
        }

        .control-section h3 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3em;
        }

        .joystick-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }

        .joystick {
            position: relative;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            touch-action: none;
        }

        .joystick-knob {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: background 0.2s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .joystick-knob.active {
            background: rgba(255, 255, 255, 1);
        }

        .joystick-label {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        .slider-container {
            margin-bottom: 30px;
        }

        .slider-label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            text-align: center;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .emergency-btn {
            width: 100%;
            padding: 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .emergency-btn:hover {
            background: #c82333;
            transform: scale(1.02);
        }

        .value-display {
            text-align: center;
            font-size: 0.9em;
            margin-top: 5px;
            opacity: 0.8;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .joystick {
                width: 120px;
                height: 120px;
            }
            
            .joystick-knob {
                width: 30px;
                height: 30px;
            }
            
            .mode-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêï Êú∫Âô®ÁãóÊéßÂà∂Âô®</h1>
            <p>ÈÄöËøáÊâãÊú∫ÊéßÂà∂ÊÇ®ÁöÑÊú∫Âô®Áãó</p>
        </div>

        <div class="status-panel">
            <div class="status-item">
                <strong>Ê®°Âºè:</strong> <span id="current-mode">Ë¢´Âä®</span>
            </div>
            <div class="status-item">
                <strong>XËΩ¥:</strong> <span id="current-vx">0.00</span>
            </div>
            <div class="status-item">
                <strong>YËΩ¥:</strong> <span id="current-vy">0.00</span>
            </div>
            <div class="status-item">
                <strong>ÊóãËΩ¨:</strong> <span id="current-wz">0.00</span>
            </div>
            <div class="status-item">
                <strong>È´òÂ∫¶:</strong> <span id="current-height">0.20</span>
            </div>
        </div>

        <div class="control-section">
            <h3>ÊéßÂà∂Ê®°Âºè</h3>
            <div class="mode-buttons">
                <button class="mode-btn passive active" onclick="setMode(0)">Ë¢´Âä®</button>
                <button class="mode-btn lie-down" onclick="setMode(1)">Ë∂¥‰∏ã</button>
                <button class="mode-btn stand-up" onclick="setMode(2)">Á´ôÁ´ã</button>
                <button class="mode-btn rl-model" onclick="setMode(3)">AIÊ®°Âºè</button>
                <button class="mode-btn soft-stop" onclick="setMode(4)">ËΩØÂÅúÊ≠¢</button>
            </div>
        </div>

        <div class="control-section">
            <h3>ÁßªÂä®ÊéßÂà∂</h3>
            <div class="joystick-container">
                <div>
                    <div class="joystick" id="movement-joystick">
                        <div class="joystick-knob"></div>
                    </div>
                    <div class="joystick-label">ÁßªÂä® (ÂâçÂêé/Â∑¶Âè≥)</div>
                    <div class="value-display">
                        X: <span id="movement-x">0.00</span> | Y: <span id="movement-y">0.00</span>
                    </div>
                </div>
                <div>
                    <div class="joystick" id="rotation-joystick">
                        <div class="joystick-knob"></div>
                    </div>
                    <div class="joystick-label">ÊóãËΩ¨</div>
                    <div class="value-display">
                        ÊóãËΩ¨: <span id="rotation-z">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="slider-container">
                <label class="slider-label">
                    È´òÂ∫¶ÊéßÂà∂: <span id="height-value">0.20</span>m
                </label>
                <input type="range" id="height-slider" class="slider" 
                       min="0" max="0.4" step="0.01" value="0.2">
            </div>
        </div>

        <button class="emergency-btn" onclick="emergencyStop()">
            üõë Á¥ßÊÄ•ÂÅúÊ≠¢
        </button>
    </div>

    <script>
        class DogController {
            constructor() {
                this.movementJoystick = new VirtualJoystick('movement-joystick');
                this.rotationJoystick = new VirtualJoystick('rotation-joystick');
                this.heightSlider = document.getElementById('height-slider');
                
                this.currentState = {
                    mode: 0,
                    vx: 0,
                    vy: 0,
                    wz: 0,
                    target_height: 0.2
                };

                this.setupEventListeners();
                this.startUpdateLoop();
                this.updateStatus();
            }

            setupEventListeners() {                // Movement joystick
                this.movementJoystick.onUpdate = (x, y) => {
                    this.currentState.vx = -y;  // Forward/backward (inverted)
                    this.currentState.vy = -x; // Left/right (inverted)
                    this.updateDisplayValues();
                };

                // Rotation joystick
                this.rotationJoystick.onUpdate = (x, y) => {
                    this.currentState.wz = -x; // Rotation (inverted)
                    this.updateDisplayValues();
                };

                // Height slider
                this.heightSlider.addEventListener('input', (e) => {
                    this.currentState.target_height = parseFloat(e.target.value);
                    document.getElementById('height-value').textContent = 
                        this.currentState.target_height.toFixed(2);
                    this.updateDisplayValues();
                });
            }

            updateDisplayValues() {
                document.getElementById('movement-x').textContent = 
                    this.currentState.vx.toFixed(2);
                document.getElementById('movement-y').textContent = 
                    this.currentState.vy.toFixed(2);
                document.getElementById('rotation-z').textContent = 
                    this.currentState.wz.toFixed(2);
            }

            startUpdateLoop() {
                setInterval(() => {
                    this.sendCommand();
                }, 100); // 10Hz update rate
            }

            async sendCommand() {
                try {
                    const response = await fetch('/api/control', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(this.currentState)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.updateStatusDisplay(data);
                    }
                } catch (error) {
                    console.error('Command send failed:', error);
                }
            }

            updateStatusDisplay(data) {
                const modeNames = ['Ë¢´Âä®', 'Ë∂¥‰∏ã', 'Á´ôÁ´ã', 'AIÊ®°Âºè', 'ËΩØÂÅúÊ≠¢'];
                document.getElementById('current-mode').textContent = 
                    modeNames[data.mode] || 'Êú™Áü•';
                document.getElementById('current-vx').textContent = data.vx.toFixed(2);
                document.getElementById('current-vy').textContent = data.vy.toFixed(2);
                document.getElementById('current-wz').textContent = data.wz.toFixed(2);
                document.getElementById('current-height').textContent = 
                    data.target_height.toFixed(2);
            }

            async updateStatus() {
                try {
                    const response = await fetch('/api/status');
                    if (response.ok) {
                        const data = await response.json();
                        this.updateStatusDisplay(data);
                    }
                } catch (error) {
                    console.error('Status update failed:', error);
                }
            }
        }

        class VirtualJoystick {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.knob = this.container.querySelector('.joystick-knob');
                this.isDragging = false;
                this.centerX = 75; // Half of container width
                this.centerY = 75; // Half of container height
                this.maxRadius = 55; // Maximum distance from center
                this.currentX = 0;
                this.currentY = 0;
                this.onUpdate = null;

                this.setupEventListeners();
            }

            setupEventListeners() {
                // Mouse events
                this.container.addEventListener('mousedown', this.startDrag.bind(this));
                document.addEventListener('mousemove', this.drag.bind(this));
                document.addEventListener('mouseup', this.endDrag.bind(this));

                // Touch events
                this.container.addEventListener('touchstart', this.startDrag.bind(this));
                document.addEventListener('touchmove', this.drag.bind(this));
                document.addEventListener('touchend', this.endDrag.bind(this));
            }

            startDrag(e) {
                this.isDragging = true;
                this.knob.classList.add('active');
                e.preventDefault();
            }

            drag(e) {
                if (!this.isDragging) return;

                const rect = this.container.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);

                let x = clientX - rect.left - this.centerX;
                let y = clientY - rect.top - this.centerY;

                // Limit movement to circle
                const distance = Math.sqrt(x * x + y * y);
                if (distance > this.maxRadius) {
                    x = (x / distance) * this.maxRadius;
                    y = (y / distance) * this.maxRadius;
                }

                // Update knob position
                this.knob.style.transform = 
                    `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;

                // Convert to normalized values (-1 to 1)
                this.currentX = x / this.maxRadius;
                this.currentY = y / this.maxRadius;

                if (this.onUpdate) {
                    this.onUpdate(this.currentX, this.currentY);
                }
            }

            endDrag() {
                if (!this.isDragging) return;

                this.isDragging = false;
                this.knob.classList.remove('active');

                // Return to center
                this.knob.style.transform = 'translate(-50%, -50%)';
                this.currentX = 0;
                this.currentY = 0;

                if (this.onUpdate) {
                    this.onUpdate(0, 0);
                }
            }
        }

        // Global functions
        async function setMode(mode) {
            try {
                const response = await fetch(`/api/mode/${mode}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Update active button
                    document.querySelectorAll('.mode-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelectorAll('.mode-btn')[mode].classList.add('active');
                    
                    controller.currentState.mode = mode;
                }
            } catch (error) {
                console.error('Mode change failed:', error);
            }
        }

        async function emergencyStop() {
            try {
                await fetch('/api/stop', { method: 'POST' });
                // Reset joysticks
                controller.movementJoystick.endDrag();
                controller.rotationJoystick.endDrag();
                // Set mode to passive
                setMode(0);
            } catch (error) {
                console.error('Emergency stop failed:', error);
            }
        }

        // Initialize controller when page loads
        let controller;
        window.addEventListener('DOMContentLoaded', () => {
            controller = new DogController();
        });
    </script>
</body>
</html>
